name: Docker Image CI

on:
  push:
    branches: [ github_actions_test ]
  pull_request:
    branches: [ github_actions_test, main]

jobs:
      
  build_docker:
    runs-on: ubuntu-latest
  
    steps:
     - uses: actions/checkout@v3
     - name: Build the Docker image
       run: cd $GITHUB_WORKSPACE && DOCKER_BUILDKIT=1 docker build --progress=plain -t panda_local_${{ github.sha }} .
  
     - name: debugging
       run: docker image ls
  
  run_nonpanda_tests:
    
    runs-on: ubuntu-latest
    needs: build_docker
    container:
      image: panda_local_${{ github.sha }}:latest
    
    strategy:
      fail-fast: false
      matrix:
        test_script: [bitGeneratorTests]
    
    steps:
        
    - name: run the tests inside the docker image
      run: >-
        docker run --name panda_local_${{ github.sha }}
        python3 ./gitHubActionRunners/${{ matrix.test_script }}.py
      
    
